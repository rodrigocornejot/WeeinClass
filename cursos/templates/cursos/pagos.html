<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Pagos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; }
    .hero {
      background: linear-gradient(90deg, #0d6efd, #084298);
      color: #fff;
      border-radius: 14px;
      padding: 22px 22px;
    }
    .shadow-soft { box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .card-rounded { border-radius: 14px; }
    .kpi {
      background: #f8fafc;
      border: 1px solid #eef2f7;
      border-radius: 12px;
      padding: 12px 14px;
      height: 100%;
    }
    .kpi .label { color: #6c757d; font-size: .85rem; }
    .kpi .value { font-weight: 700; font-size: 1.05rem; }
  </style>
</head>
<body>
<div class="container py-4" style="max-width: 980px;">

  <!-- Header -->
  <div class="hero shadow-soft mb-4 d-flex align-items-center justify-content-between">
    <div>
      <div class="h4 mb-1">üí∞ Gesti√≥n de Pagos</div>
      <div class="opacity-75">Control de cuotas, pagos parciales y estado del alumno</div>
    </div>
    <a href="{% url 'menu_admin' %}" class="btn btn-light btn-sm fw-semibold">
      ‚Üê Volver al men√∫
    </a>
  </div>

  <!-- Buscador + selector -->
  <div class="card card-rounded shadow-soft border-0 mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Buscar alumno por DNI</label>
          <input type="text" name="dni" class="form-control" placeholder="Ej: 74321098"
                 value="{{ dni|default_if_none:'' }}" required>
        </div>

        {% if matriculas and matriculas.count > 1 %}
        <div class="col-md-5">
          <label class="form-label fw-semibold">Elegir matr√≠cula / curso</label>
          <select name="matricula_id" class="form-select">
            {% for m in matriculas %}
              <option value="{{ m.id }}" {% if matricula and m.id == matricula.id %}selected{% endif %}>
                {{ m.curso.nombre }} ‚Äî {{ m.get_tipo_horario_display }} ‚Äî Inscripci√≥n: {{ m.fecha_inscripcion|date:"d/m/Y" }}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">Si el alumno tiene m√°s de un curso, elige aqu√≠ cu√°l pagar.</div>
        </div>
        {% endif %}

        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100 fw-semibold">
            Buscar
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if dni and not alumno %}
    <div class="alert alert-warning shadow-soft">No se encontr√≥ alumno con DNI <strong>{{ dni }}</strong>.</div>
  {% endif %}

  {% if alumno %}
    <div class="alert alert-info shadow-soft d-flex justify-content-between align-items-center">
      <div>üë§ <strong>Alumno:</strong> {{ alumno.nombre }} (DNI: {{ alumno.dni }})</div>
      {% if matriculas %}
        <span class="badge bg-dark">{{ matriculas.count }} matr√≠cula(s)</span>
      {% endif %}
    </div>
  {% endif %}

  {% if matricula %}
    {% if saldo_con_reprogramaciones != None and saldo_con_reprogramaciones > 0 %}
      <div class="alert alert-danger shadow-soft">‚ö† Alumno con pagos pendientes</div>
    {% else %}
      <div class="alert alert-success shadow-soft">‚úÖ Alumno al d√≠a en sus pagos</div>
    {% endif %}

    <!-- Resumen -->
    <div class="card card-rounded shadow-soft border-0 mb-4">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between mb-2">
          <div>
            <div class="h5 mb-0">üìö Resumen del Curso</div>
            <div class="text-muted">
              {{ matricula.curso.nombre }} ‚Ä¢ {{ matricula.get_tipo_horario_display }}
            </div>
          </div>

          {% if saldo_con_reprogramaciones != None and saldo_con_reprogramaciones > 0 %}
            <span class="badge text-bg-danger">PENDIENTE</span>
          {% else %}
            <span class="badge text-bg-success">AL D√çA</span>
          {% endif %}
        </div>

        <hr>

        <div class="row g-3">
          <div class="col-md-3">
            <div class="kpi">
              <div class="label">Precio base</div>
              <div class="value">S/ {{ matricula.costo_curso }}</div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="kpi">
              <div class="label">Descuento</div>
              <div class="value">{{ matricula.porcentaje }}%</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="kpi">
              <div class="label">Precio final</div>
              <div class="value">S/ {{ matricula.precio_final }}</div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="kpi">
              <div class="label">Anticipo</div>
              <div class="value text-success">S/ {{ matricula.primer_pago }}</div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="kpi">
              <div class="label">Pagado cuotas</div>
              <div class="value text-success">S/ {{ total_pagado_cuotas }}</div>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex justify-content-between">
          <span class="fw-semibold">Saldo pendiente (curso)</span>
          <span class="fw-bold text-danger">S/ {{ matricula.saldo_pendiente }}</span>
        </div>

        {% if total_reprogramaciones_pendientes and total_reprogramaciones_pendientes > 0 %}
        <div class="mt-2 d-flex justify-content-between">
          <span class="fw-semibold">Reprogramaciones pendientes</span>
          <span class="fw-bold text-danger">S/ {{ total_reprogramaciones_pendientes }}</span>
        </div>
        {% endif %}

        {% if saldo_con_reprogramaciones != None %}
        <div class="mt-2 d-flex justify-content-between">
          <span class="fw-semibold">Saldo total (incluye reprogramaciones)</span>
          <span class="fw-bold text-danger">S/ {{ saldo_con_reprogramaciones }}</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- ‚úÖ Reprogramaciones pendientes -->
    {% if reprogramaciones_pendientes %}
    <div class="card card-rounded shadow-soft border-0 mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="h5 mb-0">üîÅ Reprogramaciones pendientes</div>
          <div class="text-muted small">Estas reprogramaciones requieren pago antes de aplicar el cambio.</div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>Clase</th>
                <th>Fecha anterior</th>
                <th>Nueva fecha</th>
                <th>Monto</th>
                <th style="width: 280px;">Pagar</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reprogramaciones_pendientes %}
              <tr>
                <td class="fw-semibold">#{{ r.clase.id }}</td>
                <td>{{ r.fecha_anterior }}</td>
                <td class="fw-semibold">{{ r.fecha_nueva }}</td>
                <td class="fw-bold text-danger">S/ {{ r.monto }}</td>
                <td>
                  {% if r.id %}
                  <form method="post"
                        action="{% url 'pagar_reprogramacion_pagos' r.id %}"
                        class="d-flex gap-2 justify-content-center align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="dni" value="{{ dni }}">
                    <input type="hidden" name="matricula_id" value="{{ matricula.id }}">

                    <select name="metodo_pago" class="form-select form-select-sm" style="width: 140px;" required>
                      <option value="">M√©todo</option>
                      <option value="yape">Yape</option>
                      <option value="plin">Plin</option>
                      <option value="izipay">Izipay</option>
                      <option value="interbank">Interbank</option>
                      <option value="culqi">Culqi</option>
                      <option value="efectivo">Efectivo</option>
                    </select>

                    <button type="submit" class="btn btn-sm btn-success fw-semibold">
                      Pagar
                    </button>
                  </form>
                  {% else %}
                    <span class="text-danger">ID inv√°lido</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
    {% endif %}

    <!-- Cuotas -->
    <div class="card card-rounded shadow-soft border-0">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="h5 mb-0">üßæ Cuotas</div>
          <div class="text-muted small">Puedes registrar pagos parciales (se actualizar√° el saldo).</div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>Cuota</th>
                <th>Monto</th>
                <th>Pagado</th>
                <th>Saldo</th>
                <th style="width: 360px;">Registrar pago</th>
              </tr>
            </thead>
            <tbody>
              {% if cuotas %}
                {% for cuota in cuotas %}
                <tr>
                  <td class="fw-semibold">Cuota {{ cuota.numero }}</td>
                  <td>S/ {{ cuota.monto }}</td>
                  <td class="text-success">S/ {{ cuota.monto_pagado }}</td>
                  <td class="text-danger">S/ {{ cuota.saldo_cuota }}</td>
                  <td>
                    {% if cuota.esta_pagada %}
                      <span class="badge text-bg-success">Pagada</span>
                    {% else %}
                      <!-- ‚úÖ ESTE FORM ES PARA CUOTAS (NO reprogramaciones) -->
                      <form method="post"
                            action="{% url 'pagar_cuota' cuota.id %}"
                            class="d-flex gap-2 justify-content-center align-items-center">
                        {% csrf_token %}

                        <input type="hidden" name="dni" value="{{ dni }}">
                        <input type="hidden" name="matricula_id" value="{{ matricula.id }}">

                        <select name="metodo_pago"
                                class="form-select form-select-sm"
                                style="width: 120px;"
                                required>
                          <option value="">M√©todo</option>
                          <option value="yape">Yape</option>
                          <option value="plin">Plin</option>
                          <option value="izipay">Izipay</option>
                          <option value="interbank">Interbank</option>
                          <option value="culqi">Culqi</option>
                          <option value="efectivo">Efectivo</option>
                        </select>

                        <input type="number"
                              name="monto"
                              step="0.01"
                              min="0.01"
                              max="{{ cuota.saldo_cuota }}"
                              class="form-control form-control-sm"
                              style="width: 110px;"
                              placeholder="Monto"
                              required>

                        <button type="submit" class="btn btn-sm btn-success fw-semibold">
                          Pagar
                        </button>
                      </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="5" class="text-muted py-4">No hay cuotas registradas para esta matr√≠cula.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
