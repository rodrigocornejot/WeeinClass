<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar MatrÃ­cula</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    .hidden { display: none; }
  </style>
</head>

<body>
<div class="container mt-5">
  <h3 class="text-center mb-4">Registrar MatrÃ­cula</h3>

  <div class="d-flex justify-content-between mb-3">
    <a href="{% url 'menu_admin' %}" class="btn btn-secondary">â¬… Volver</a>
    <a href="{% url 'lista_matriculas' %}" class="btn btn-dark">ðŸ“‹ Ver matrÃ­culas</a>
  </div>

  <!-- ðŸ” BUSCAR POR DNI -->
  <form method="get" class="mb-4">
    <label class="form-label">DNI del alumno</label>
    <input type="text" name="dni" class="form-control" placeholder="Ingrese DNI" value="{{ dni }}">
    <button class="btn btn-secondary mt-2">Buscar</button>
  </form>

  <!-- ðŸ“Œ MOSTRAR ALUMNO -->
  <div class="mb-3">
    <label class="form-label">Alumno</label>
    <input type="text" class="form-control"
           value="{% if alumno %}{{ alumno.nombre }}{% else %}No encontrado{% endif %}"
           readonly>
  </div>

  <!-- âœ… ERRORES -->
  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Hay errores en el formulario:</strong>
      <pre style="white-space:pre-wrap">{{ form.errors }}</pre>
      {% if form.non_field_errors %}
        <hr>
        <pre style="white-space:pre-wrap">{{ form.non_field_errors }}</pre>
      {% endif %}
    </div>
  {% endif %}

  <!-- ðŸ“ FORMULARIO MATRÃCULA -->
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="dni" value="{{ dni }}">

    <!-- CURSO -->
    <div class="mb-3">
      {{ form.curso.label_tag }}
      {{ form.curso }}
    </div>

    <!-- MODALIDAD (solo full y extendida) -->
    <div class="mb-3">
      {{ form.modalidad.label_tag }}
      {{ form.modalidad }}
    </div>

    <!-- FECHA INICIO (solo automÃ¡tico) -->
    <div class="mb-3" id="fecha_inicio_box">
      {{ form.fecha_inicio.label_tag }}
      {{ form.fecha_inicio }}
    </div>

    <!-- âœ… CHECKBOX PERSONALIZAR FECHAS -->
    <div class="form-check mb-3">
      {{ form.personalizar_fechas }}
      <label class="form-check-label" for="id_personalizar_fechas">
        ðŸ“Œ Personalizar fechas de clases
      </label>
    </div>

    <!-- DÃAS (solo automÃ¡tico + extendida) -->
    <div class="mb-3 hidden" id="dias_box">
      {{ form.dias.label_tag }}
      {{ form.dias }}
    </div>

    <!-- PERSONALIZAR (inputs clase_1..clase_N) -->
    <div class="mb-3 hidden" id="personalizado_box">
      <div class="alert alert-info">
        Selecciona la fecha de cada clase:
        <ul class="mb-0">
          <li><b>Full Day</b>: 3 fechas</li>
          <li><b>Extendida</b>: 6 fechas</li>
        </ul>
      </div>
      <div id="sesiones_container" class="row g-2"></div>
    </div>

    <!-- COSTOS (âœ… usar fields del form) -->
    <div class="row mt-2">
      <div class="col-md-4">
        {{ form.costo_curso.label_tag }}
        {{ form.costo_curso }}
      </div>
      <div class="col-md-4">
        {{ form.primer_pago.label_tag }}
        {{ form.primer_pago }}
      </div>
      <div class="col-md-4">
        {{ form.porcentaje.label_tag }}
        {{ form.porcentaje }}
      </div>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-success">Guardar MatrÃ­cula</button>
    </div>
  </form>
</div>

<script>
function totalClasesPorModalidad() {
  const mod = ($('#id_modalidad').val() || '').toLowerCase();
  if (mod === 'full') return 3;
  if (mod === 'extendida') return 6;
  return 0;
}

function renderClases(n) {
  const $c = $('#sesiones_container');
  $c.empty();

  for (let i = 1; i <= n; i++) {
    $c.append(`
      <div class="col-12 col-md-6">
        <label class="form-label">Clase ${i}</label>
        <input type="date" class="form-control" name="sesion_${i}" required>
      </div>
    `);
  }
}

function toggleUI() {
  const mod = ($('#id_modalidad').val() || '').toLowerCase();
  const personalizar = $('#id_personalizar_fechas').is(':checked');

  // Mostrar/Ocultar boxes
  $('#personalizado_box').toggleClass('hidden', !personalizar);

  // DÃ­as solo si NO personaliza y es extendida
  const mostrarDias = (!personalizar && mod === 'extendida');
  $('#dias_box').toggleClass('hidden', !mostrarDias);

  // fecha_inicio solo si NO personaliza
  $('#fecha_inicio_box').toggleClass('hidden', personalizar);

  // Render inputs personalizados
  if (personalizar) {
    renderClases(totalClasesPorModalidad());
  } else {
    // si desmarcan personalizar, que no queden inputs required escondidos
    $('#sesiones_container').empty();
  }
}

$('#id_modalidad').on('change', toggleUI);
$('#id_personalizar_fechas').on('change', toggleUI);
$(document).ready(toggleUI);
</script>

</body>
</html>
