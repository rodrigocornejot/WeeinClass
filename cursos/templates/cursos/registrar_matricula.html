<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar MatrÃ­cula</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#2563eb;
      --border:#e2e8f0;
      --shadow:0 10px 28px rgba(15,23,42,.08);
      --radius:16px;
    }
    body{ background:var(--bg); color:var(--text); }
    .page-wrap{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px 12px; }
    .card-soft{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      max-width:980px;
      width:100%;
    }
    .header{
      background:linear-gradient(135deg, #0b1f3a 0%, #1f6feb 100%);
      color:#fff;
      padding:22px 22px;
    }
    .header h3{ margin:0; font-weight:800; letter-spacing:.2px; }
    .header p{ margin:6px 0 0; opacity:.9; }
    .content{ padding:22px; }
    .btn-soft{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .btn-soft:hover{ background:rgba(255,255,255,.16); color:#fff; }
    .section-title{
      font-weight:800;
      font-size:1rem;
      margin:18px 0 10px;
      color:var(--text);
    }
    .hint{ color:var(--muted); font-size:.9rem; }
    .form-control, .form-select{
      border-radius:12px;
      border-color:var(--border);
      padding:.65rem .85rem;
    }
    .form-control:focus, .form-select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 .2rem rgba(37,99,235,.15);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#eef2ff; color:#1e40af;
      border:1px solid #dbeafe;
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:.9rem;
      width:100%;
      justify-content:center;
      min-height:44px;
    }
    .hidden{ display:none; }
    .divider{ height:1px; background:var(--border); margin:18px 0; }
    .mini-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      background:#fff;
    }
    .radio-chip{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      border:1px solid var(--border);
      padding:.45rem .6rem;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .radio-chip input{ margin:0; }
    .radio-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .badge-soft{
      background:#eff6ff;
      color:#1d4ed8;
      border:1px solid #dbeafe;
      font-weight:700;
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <div class="card-soft">

    <!-- Header -->
    <div class="header d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h3>Registrar MatrÃ­cula</h3>
        <p class="mb-0">Crea la matrÃ­cula, define fechas y horario por clase, y registra el anticipo con su mÃ©todo.</p>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'menu_admin' %}" class="btn btn-sm btn-soft">â¬… Volver</a>
        <a href="{% url 'lista_matriculas' %}" class="btn btn-sm btn-light">ðŸ“‹ Ver matrÃ­culas</a>
      </div>
    </div>

    <div class="content">

      <!-- Buscar DNI -->
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-8">
          <label class="form-label fw-semibold">Buscar alumno por DNI</label>
          <form method="get" class="d-flex gap-2">
            <input type="text" name="dni" class="form-control" placeholder="Ingrese DNI" value="{{ dni }}">
            <button class="btn btn-primary px-4">Buscar</button>
          </form>
          <div class="hint mt-2">Tip: primero busca el DNI, luego completa el formulario.</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label fw-semibold">Alumno</label>
          <div class="pill">
            ðŸ‘¤
            <span>{% if alumno %}{{ alumno.nombre }}{% else %}No encontrado{% endif %}</span>
          </div>
        </div>
      </div>

      {% if form.errors %}
        <div class="alert alert-danger mt-3">
          <strong>Hay errores en el formulario:</strong>
          <pre style="white-space:pre-wrap" class="mb-0">{{ form.errors }}</pre>
          {% if form.non_field_errors %}
            <hr><pre style="white-space:pre-wrap" class="mb-0">{{ form.non_field_errors }}</pre>
          {% endif %}
        </div>
      {% endif %}

      <div class="divider"></div>

      <!-- Form matrÃ­cula -->
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="dni" value="{{ dni }}">

        <!-- Datos del curso -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div>
                <h5 class="mb-0">Datos del curso</h5>
                <small class="text-muted">Selecciona el curso y el tipo</small>
              </div>
              <span class="badge badge-soft">MatrÃ­cula</span>
            </div>

            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <label class="form-label fw-semibold">{{ form.curso.label }}</label>
                {{ form.curso }}
                <div class="form-text">Elige el curso que llevarÃ¡ el alumno.</div>
              </div>

              <div class="col-12 col-md-6 col-lg-3">
                <label class="form-label fw-semibold">{{ form.modalidad.label }}</label>
                {{ form.modalidad }}
              </div>

              <div class="col-12 col-md-6 col-lg-3">
                <label class="form-label fw-semibold">{{ form.tipo_horario.label }}</label>
                {{ form.tipo_horario }}
              </div>
            </div>

            <hr class="my-4">

            <!-- Switch personalizar -->
            <div class="form-check form-switch">
              <input
                type="checkbox"
                name="personalizar_fechas"
                id="id_personalizar_fechas"
                class="form-check-input"
                {% if personalizar_post %}checked{% endif %}
              >
              <label class="form-check-label fw-semibold" for="id_personalizar_fechas">
                ðŸ“Œ Personalizar fechas (y horario por clase)
              </label>
              <div class="form-text">
                Si lo activas, podrÃ¡s elegir la fecha de cada clase y su horario (9â€“1 / 2â€“6 / 9â€“6).
              </div>
            </div>
          </div>
        </div>

        <!-- AutomÃ¡tico -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-md-6" id="fecha_inicio_box">
            <label class="form-label fw-semibold">{{ form.fecha_inicio.label }}</label>
            {{ form.fecha_inicio }}
          </div>

          <div class="col-12 col-md-6" id="dias_box">
            <label class="form-label fw-semibold">{{ form.dias.label }}</label>
            {{ form.dias }}
            <div class="hint mt-1">Selecciona dÃ­as si NO personalizas fechas.</div>
          </div>
        </div>

        <!-- Personalizar -->
        <div class="mt-3 hidden" id="personalizado_box">
          <div class="alert alert-info mb-2" id="help_personalizado"></div>
          <div id="sesiones_container" class="row g-3"></div>
        </div>

        <div class="divider"></div>

        <!-- Pagos/Descuento -->
        <div class="section-title">Datos de pago y descuento</div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">{{ form.costo_curso.label }}</label>
            {{ form.costo_curso }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">{{ form.primer_pago.label }}</label>
            {{ form.primer_pago }}
            <div class="hint mt-1">Si es 0, no se registrarÃ¡ anticipo.</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">{{ form.porcentaje.label }}</label>
            {{ form.porcentaje }}
          </div>
        </div>

        <!-- MÃ©todo de pago -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">MÃ©todo de pago (anticipo)</label>

            {% with sel=request.POST.metodo_pago_anticipo %}
            <select name="metodo_pago_anticipo" class="form-select">
              <option value="" {% if not sel %}selected{% endif %}>â€” Seleccionar â€”</option>
              <option value="plin" {% if sel == "plin" %}selected{% endif %}>Plin</option>
              <option value="yape" {% if sel == "yape" %}selected{% endif %}>Yape</option>
              <option value="izipay" {% if sel == "izipay" %}selected{% endif %}>Izipay</option>
              <option value="interbank" {% if sel == "interbank" %}selected{% endif %}>Interbank</option>
              <option value="culqi" {% if sel == "culqi" %}selected{% endif %}>Culqi</option>
              <option value="efectivo" {% if sel == "efectivo" %}selected{% endif %}>Efectivo</option>
            </select>
            {% endwith %}

            <div class="hint mt-1">Este mÃ©todo se guardarÃ¡ en el pago del anticipo.</div>
          </div>
        </div>

        <div class="text-end mt-4">
          <button class="btn btn-primary btn-lg px-4">âœ… Guardar MatrÃ­cula</button>
        </div>
      </form>

    </div>
  </div>
</div>

{{ sesiones_post|default:"[]"|json_script:"sesiones-post-data" }}
{{ horarios_post|default:"[]"|json_script:"horarios-post-data" }}

<script>
const SESIONES_POST = JSON.parse(document.getElementById("sesiones-post-data").textContent);
const HORARIOS_POST = JSON.parse(document.getElementById("horarios-post-data").textContent);

const HORARIOS = [
  { value: "9-1", label: "9â€“1" },
  { value: "2-6", label: "2â€“6" },
  { value: "9-6", label: "9â€“6" },
];

function totalClasesPorTipo() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  if (tipo.startsWith('full')) return 3;     // Full Day
  if (tipo === 'extendida') return 6;        // Extendida
  return 0;
}

function renderClases(n) {
  const $c = $('#sesiones_container');
  $c.empty();

  for (let i = 1; i <= n; i++) {
    const fechaVal = (SESIONES_POST[i-1] || "");
    const horarioVal = (HORARIOS_POST[i-1] || "9-1"); // default 9-1

    const radios = HORARIOS.map(h => {
      const checked = (horarioVal === h.value) ? "checked" : "";
      return `
        <label class="radio-chip">
          <input type="radio" name="horario_${i}" value="${h.value}" ${checked} required>
          <span class="fw-semibold">${h.label}</span>
        </label>
      `;
    }).join("");

    $c.append(`
      <div class="col-12">
        <div class="mini-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">Clase ${i}</div>
            <span class="badge text-bg-light border">Fecha + Horario</span>
          </div>

          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold mb-1">Fecha</label>
              <input type="date" class="form-control" name="sesion_${i}" value="${fechaVal}" required>
            </div>

            <div class="col-12 col-md-8">
              <label class="form-label fw-semibold mb-1">Horario</label>
              <div class="radio-row">
                ${radios}
              </div>
              <div class="hint mt-1">Se guardarÃ¡ para el modal de esa clase.</div>
            </div>
          </div>
        </div>
      </div>
    `);
  }
}

function toggleUI() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  const personalizar = $('#id_personalizar_fechas').is(':checked');

  const esFull = tipo.startsWith('full');
  const esExtendida = (tipo === 'extendida');
  const aplica = esFull || esExtendida;

  // automÃ¡tico
  $('#fecha_inicio_box').toggle(!personalizar);
  $('#dias_box').toggle(aplica && (!personalizar));

  // personalizado
  $('#personalizado_box').toggleClass('hidden', !(aplica && personalizar));

  if (aplica && personalizar) {
    const n = totalClasesPorTipo();
    $('#help_personalizado').text(
      esFull ? "Elige la fecha y el horario de cada clase (Full Day = 3 clases)." :
      esExtendida ? "Elige la fecha y el horario de cada clase (Extendida = 6 clases)." :
      ""
    );
    renderClases(n);
  }
}

$('#id_tipo_horario').on('change', toggleUI);
$('#id_personalizar_fechas').on('change', toggleUI);
$(document).ready(toggleUI);
</script>

</body>
</html>
