<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Matr√≠cula</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    .hidden { display: none; }
  </style>
</head>

<body>
<div class="container mt-5">
  <h3 class="text-center mb-4">Registrar Matr√≠cula</h3>

  <div class="d-flex justify-content-between mb-3">
    <a href="{% url 'menu_admin' %}" class="btn btn-secondary">‚¨Ö Volver</a>
    <a href="{% url 'lista_matriculas' %}" class="btn btn-dark">üìã Ver matr√≠culas</a>
  </div>

  <!-- üîç BUSCAR POR DNI -->
  <form method="get" class="mb-4">
    <label class="form-label">DNI del alumno</label>
    <input type="text" name="dni" class="form-control" placeholder="Ingrese DNI" value="{{ dni }}">
    <button class="btn btn-secondary mt-2">Buscar</button>
  </form>

  <!-- üìå MOSTRAR ALUMNO -->
  <div class="mb-3">
    <label class="form-label">Alumno</label>
    <input type="text" class="form-control" value="{% if alumno %}{{ alumno.nombre }}{% else %}No encontrado{% endif %}" readonly>
  </div>

  <!-- ‚úÖ ERRORES -->
  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Hay errores en el formulario:</strong>
      <pre style="white-space:pre-wrap">{{ form.errors }}</pre>
      {% if form.non_field_errors %}
        <hr>
        <pre style="white-space:pre-wrap">{{ form.non_field_errors }}</pre>
      {% endif %}
    </div>
  {% endif %}

  <!-- üìù FORMULARIO MATR√çCULA -->
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="dni" value="{{ dni }}">

    <!-- CURSO -->
    <div class="mb-3">
      {{ form.curso.label_tag }}
      {{ form.curso }}
    </div>

    <!-- MODALIDAD -->
    <div class="mb-3">
      {{ form.modalidad.label_tag }}
      {{ form.modalidad }}
    </div>

    <!-- TIPO HORARIO -->
    <div class="mb-3">
      {{ form.tipo_horario.label_tag }}
      {{ form.tipo_horario }}
    </div>

    <!-- D√çAS (no-personalizado) -->
    <div class="mb-3 hidden" id="dias_box">
      {{ form.dias.label_tag }}
      {{ form.dias }}
    </div>

    <!-- PERSONALIZADO (sesi√≥n 1..N) -->
    <div class="mb-3 hidden" id="personalizado_box">
      <div class="alert alert-info">
        Selecciona la fecha de cada sesi√≥n (seg√∫n el curso: 5 o 6).
      </div>
      <div id="sesiones_container" class="row g-2"></div>
    </div>

    <!-- FECHA INICIO (no-personalizado) -->
    <div class="mb-3" id="fecha_inicio_box">
      {{ form.fecha_inicio.label_tag }}
      {{ form.fecha_inicio }}
    </div>

    <!-- COSTOS (‚úÖ usar fields del form) -->
    <div class="row mt-2">
      <div class="col-md-4">
        {{ form.costo_curso.label_tag }}
        {{ form.costo_curso }}
      </div>
      <div class="col-md-4">
        {{ form.primer_pago.label_tag }}
        {{ form.primer_pago }}
      </div>
      <div class="col-md-4">
        {{ form.porcentaje.label_tag }}
        {{ form.porcentaje }}
      </div>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-success">Guardar Matr√≠cula</button>
    </div>
  </form>
</div>

{{ curso_sesiones_por_id|json_script:"curso-sesiones-data" }}

<script>
const CURSO_SESIONES_POR_ID = JSON.parse(
  document.getElementById("curso-sesiones-data").textContent
);

function getSesionesCursoSeleccionado() {
  const cursoId = $('#id_curso').val();
  const n = CURSO_SESIONES_POR_ID[String(cursoId)];
  return n ? parseInt(n) : 6;
}

function renderSesionesPersonalizadas(n) {
  const $c = $('#sesiones_container');
  $c.empty();

  for (let i = 1; i <= n; i++) {
    $c.append(`
      <div class="col-12 col-md-6">
        <label class="form-label">Sesi√≥n ${i}</label>
        <input type="date" class="form-control" name="sesion_${i}" required>
      </div>
    `);
  }
}

function toggleUI() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  const esPersonalizado = (tipo === 'personalizado');
  const esFull = (tipo.startsWith('full'));
  const esExtendida = (tipo === 'extendida');

  $('#personalizado_box').toggleClass('hidden', !esPersonalizado);
  $('#dias_box').toggleClass('hidden', esPersonalizado || esFull);
  $('#fecha_inicio_box').toggleClass('hidden', esPersonalizado);

  // Si no es personalizado y es extendida => s√≠ necesita d√≠as
  if (!esPersonalizado) {
    $('#dias_box').toggleClass('hidden', !(esExtendida));
  }

  if (esPersonalizado) {
    renderSesionesPersonalizadas(getSesionesCursoSeleccionado());
  }
}

$('#id_tipo_horario').on('change', toggleUI);
$('#id_curso').on('change', function(){
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  if (tipo === 'personalizado') {
    renderSesionesPersonalizadas(getSesionesCursoSeleccionado());
  }
});

$(document).ready(toggleUI);
</script>

</body>
</html>
