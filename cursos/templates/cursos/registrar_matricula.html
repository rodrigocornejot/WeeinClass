<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar MatrÃ­cula</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>.hidden{display:none;}</style>
</head>

<body>
<div class="container mt-5">
  <h3 class="text-center mb-4">Registrar MatrÃ­cula</h3>

  <div class="d-flex justify-content-between mb-3">
    <a href="{% url 'menu_admin' %}" class="btn btn-secondary">â¬… Volver</a>
    <a href="{% url 'lista_matriculas' %}" class="btn btn-dark">ðŸ“‹ Ver matrÃ­culas</a>
  </div>

  <form method="get" class="mb-4">
    <label class="form-label">DNI del alumno</label>
    <input type="text" name="dni" class="form-control" placeholder="Ingrese DNI" value="{{ dni }}">
    <button class="btn btn-secondary mt-2">Buscar</button>
  </form>

  <div class="mb-3">
    <label class="form-label">Alumno</label>
    <input type="text" class="form-control"
           value="{% if alumno %}{{ alumno.nombre }}{% else %}No encontrado{% endif %}" readonly>
  </div>

  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Hay errores en el formulario:</strong>
      <pre style="white-space:pre-wrap">{{ form.errors }}</pre>
      {% if form.non_field_errors %}
        <hr><pre style="white-space:pre-wrap">{{ form.non_field_errors }}</pre>
      {% endif %}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="dni" value="{{ dni }}">

    <div class="mb-3">
      {{ form.curso.label_tag }} {{ form.curso }}
    </div>

    <div class="mb-3">
      {{ form.modalidad.label_tag }} {{ form.modalidad }}
    </div>

    <div class="mb-3">
      {{ form.tipo_horario.label_tag }} {{ form.tipo_horario }}
    </div>

    <div class="mb-3" id="fecha_inicio_box">
      {{ form.fecha_inicio.label_tag }} {{ form.fecha_inicio }}
    </div>

    <div class="mb-3" id="dias_box">
      {{ form.dias.label_tag }} {{ form.dias }}
    </div>

    <div class="form-check mb-3">
      <input type="checkbox" name="personalizar_fechas" id="id_personalizar_fechas"
             class="form-check-input" {% if personalizar_post %}checked{% endif %}>
      <label class="form-check-label" for="id_personalizar_fechas">
        ðŸ“Œ Personalizar fechas de clases
      </label>
    </div>

    <div class="mb-3 hidden" id="personalizado_box">
      <div class="alert alert-info" id="help_personalizado"></div>
      <div id="sesiones_container" class="row g-2"></div>
    </div>

    <div class="row mt-2">
      <div class="col-md-4">{{ form.costo_curso.label_tag }} {{ form.costo_curso }}</div>
      <div class="col-md-4">{{ form.primer_pago.label_tag }} {{ form.primer_pago }}</div>
      <div class="col-md-4">{{ form.porcentaje.label_tag }} {{ form.porcentaje }}</div>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-success">Guardar MatrÃ­cula</button>
    </div>
  </form>
</div>

{{ sesiones_post|default:"[]"|json_script:"sesiones-post-data" }}

<script>
const SESIONES_POST = JSON.parse(document.getElementById("sesiones-post-data").textContent);

function totalClasesPorTipo() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  // âœ… Full Day = 3 clases (2 sesiones por clase)
  if (tipo.startsWith('full')) return 3;
  // âœ… Extendida = 6 clases (1 sesiÃ³n por clase)
  if (tipo === 'extendida') return 6;
  return 0;
}

function renderClases(n) {
  const $c = $('#sesiones_container');
  $c.empty();

  for (let i = 1; i <= n; i++) {
    const val = (SESIONES_POST[i-1] || "");
    $c.append(`
      <div class="col-12 col-md-6">
        <label class="form-label">Clase ${i}</label>
        <input type="date" class="form-control" name="sesion_${i}" value="${val}" required>
      </div>
    `);
  }
}

function toggleUI() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  const personalizar = $('#id_personalizar_fechas').is(':checked');

  const esFull = tipo.startsWith('full');
  const esExtendida = (tipo === 'extendida');
  const aplica = esFull || esExtendida;

  // âœ… si no aplica, ocultar
  $('#dias_box').toggle(aplica);

  // âœ… regla de dÃ­as: si NO personaliza:
  // - Full Day: puedes decidir si pides dÃ­as o no. AquÃ­ lo muestro igual.
  // - Extendida: sÃ­ o sÃ­ dÃ­as.
  // Ajusta si quieres: si full no debe pedir dÃ­as => $('#dias_box').toggle(esExtendida);
  $('#dias_box').toggle(aplica && (!personalizar));

  // âœ… personalizado
  $('#personalizado_box').toggleClass('hidden', !(aplica && personalizar));
  $('#fecha_inicio_box').toggle(!personalizar);

  if (aplica && personalizar) {
    const n = totalClasesPorTipo();
    $('#help_personalizado').text(
      esFull ? "Elige la fecha de cada clase (Full Day = 3 clases)." :
      esExtendida ? "Elige la fecha de cada clase (Extendida = 6 clases)." :
      ""
    );
    renderClases(n);
  }
}

$('#id_tipo_horario').on('change', toggleUI);
$('#id_personalizar_fechas').on('change', toggleUI);
$(document).ready(toggleUI);
</script>

</body>
</html>
