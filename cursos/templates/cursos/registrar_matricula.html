<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Matr√≠cula</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#2563eb;
      --border:#e2e8f0;
      --shadow:0 10px 28px rgba(15,23,42,.08);
      --radius:16px;
    }
    body{ background:var(--bg); color:var(--text); }
    .page-wrap{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px 12px; }
    .card-soft{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      max-width:980px;
      width:100%;
    }
    .header{
      background:linear-gradient(135deg, #0b1f3a 0%, #1f6feb 100%);
      color:#fff;
      padding:22px 22px;
    }
    .header h3{ margin:0; font-weight:800; letter-spacing:.2px; }
    .header p{ margin:6px 0 0; opacity:.9; }
    .content{ padding:22px; }
    .btn-soft{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .btn-soft:hover{ background:rgba(255,255,255,.16); color:#fff; }
    .section-title{
      font-weight:800;
      font-size:1rem;
      margin:18px 0 10px;
      color:var(--text);
    }
    .hint{ color:var(--muted); font-size:.9rem; }
    .form-control, .form-select{
      border-radius:12px;
      border-color:var(--border);
      padding:.65rem .85rem;
    }
    .form-control:focus, .form-select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 .2rem rgba(37,99,235,.15);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#eef2ff; color:#1e40af;
      border:1px solid #dbeafe;
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:.9rem;
    }
    .hidden{ display:none; }
    .divider{ height:1px; background:var(--border); margin:18px 0; }

    /* Tarjeta bonita para cada sesi√≥n */
    .session-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 14px rgba(15,23,42,.06);
    }
    .session-title{ font-weight:800; margin-bottom:10px; }
    .btn-group .btn{
      border-radius:12px !important;
      padding:.45rem .8rem;
      border-color:var(--border);
    }
    .btn-check:checked + .btn{
      border-color:#93c5fd;
      box-shadow:0 0 0 .2rem rgba(37,99,235,.12);
    }
  </style>
</head>

<body>
<div class="page-wrap">
  <div class="card-soft">

    <!-- Header -->
    <div class="header d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h3>Registrar Matr√≠cula</h3>
        <p class="mb-0">Crea la matr√≠cula, define fechas de clases y registra el anticipo con su m√©todo.</p>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'menu_admin' %}" class="btn btn-sm btn-soft">‚¨Ö Volver</a>
        <a href="{% url 'lista_matriculas' %}" class="btn btn-sm btn-light">üìã Ver matr√≠culas</a>
      </div>
    </div>

    <div class="content">

      <!-- Buscar DNI -->
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-8">
          <label class="form-label fw-semibold">Buscar alumno por DNI</label>
          <form method="get" class="d-flex gap-2">
            <input type="text" name="dni" class="form-control" placeholder="Ingrese DNI" value="{{ dni }}">
            <button class="btn btn-primary px-4">Buscar</button>
          </form>
          <div class="hint mt-2">Tip: primero busca el DNI, luego completa el formulario.</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label fw-semibold">Alumno</label>
          <div class="pill w-100 justify-content-center">
            üë§
            <span>
              {% if alumno %}{{ alumno.nombre }}{% else %}No encontrado{% endif %}
            </span>
          </div>
        </div>
      </div>

      {% if form.errors %}
        <div class="alert alert-danger mt-3">
          <strong>Hay errores en el formulario:</strong>
          <pre style="white-space:pre-wrap" class="mb-0">{{ form.errors }}</pre>
          {% if form.non_field_errors %}
            <hr><pre style="white-space:pre-wrap" class="mb-0">{{ form.non_field_errors }}</pre>
          {% endif %}
        </div>
      {% endif %}

      <div class="divider"></div>

      <!-- Form matr√≠cula -->
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="dni" value="{{ dni }}">

        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body p-4">

            <div class="d-flex align-items-center justify-content-between mb-3">
              <div>
                <h5 class="mb-0">Datos del curso</h5>
                <small class="text-muted">Selecciona el curso y el tipo de matr√≠cula</small>
              </div>
              <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Matr√≠cula</span>
            </div>

            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <label class="form-label fw-semibold">{{ form.curso.label }}</label>
                {{ form.curso }}
                <div class="form-text">Elige el curso que llevar√° el alumno.</div>
              </div>

              <div class="col-12 col-md-6 col-lg-3">
                <label class="form-label fw-semibold">{{ form.modalidad.label }}</label>
                {{ form.modalidad }}
              </div>

              <div class="col-12 col-md-6 col-lg-3">
                <label class="form-label fw-semibold">{{ form.tipo_horario.label }}</label>
                {{ form.tipo_horario }}
              </div>
            </div>

            <hr class="my-4">

            <!-- ‚úÖ SOLO UNO: switch personalizar -->
            <div class="form-check form-switch">
              <input
                type="checkbox"
                name="personalizar_fechas"
                id="id_personalizar_fechas"
                class="form-check-input"
                {% if personalizar_post %}checked{% endif %}
              >
              <label class="form-check-label fw-semibold" for="id_personalizar_fechas">
                üìå Personalizar fechas de clases
              </label>
              <div class="form-text">Act√≠valo si deseas elegir manualmente las fechas y el horario de cada sesi√≥n.</div>
            </div>

          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-12 col-md-6" id="fecha_inicio_box">
            <label class="form-label fw-semibold">{{ form.fecha_inicio.label }}</label>
            {{ form.fecha_inicio }}
          </div>

          <div class="col-12 col-md-6" id="dias_box">
            <label class="form-label fw-semibold">{{ form.dias.label }}</label>
            {{ form.dias }}
            <div class="hint mt-1">Selecciona d√≠as si NO personalizas fechas.</div>
          </div>
        </div>

        <!-- ‚úÖ Caja fechas personalizadas (sin duplicados) -->
        <div class="mt-3 hidden" id="personalizado_box">
          <div class="alert alert-info mb-2" id="help_personalizado"></div>
          <div id="sesiones_container" class="row g-3"></div>
        </div>

        <div class="divider"></div>

        <!-- Pagos/Descuento -->
        <div class="section-title">Datos de pago y descuento</div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">{{ form.costo_curso.label }}</label>
            {{ form.costo_curso }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">{{ form.primer_pago.label }}</label>
            {{ form.primer_pago }}
            <div class="hint mt-1">Si es 0, no se registrar√° anticipo.</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">{{ form.porcentaje.label }}</label>
            {{ form.porcentaje }}
          </div>
        </div>

        <!-- ‚úÖ M√âTODO DE PAGO DEL ANTICIPO -->
        <div class="row g-3 mt-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">M√©todo de pago (anticipo)</label>

            {% with sel=request.POST.metodo_pago_anticipo %}
            <select name="metodo_pago_anticipo" class="form-select">
              <option value="" {% if not sel %}selected{% endif %}>‚Äî Seleccionar ‚Äî</option>
              <option value="plin" {% if sel == "plin" %}selected{% endif %}>Plin</option>
              <option value="yape" {% if sel == "yape" %}selected{% endif %}>Yape</option>
              <option value="izipay" {% if sel == "izipay" %}selected{% endif %}>Izipay</option>
              <option value="interbank" {% if sel == "interbank" %}selected{% endif %}>Interbank</option>
              <option value="culqi" {% if sel == "culqi" %}selected{% endif %}>Culqi</option>
              <option value="efectivo" {% if sel == "efectivo" %}selected{% endif %}>Efectivo</option>
            </select>
            {% endwith %}

            <div class="hint mt-1">Este m√©todo se guardar√° en el pago del anticipo.</div>
          </div>
        </div>

        <div class="text-end mt-4">
          <button class="btn btn-primary btn-lg px-4">‚úÖ Guardar Matr√≠cula</button>
        </div>
      </form>

    </div>
  </div>
</div>

{{ sesiones_post|default:"[]"|json_script:"sesiones-post-data" }}
{{ horarios_post|default:"[]"|json_script:"horarios-post-data" }}

<script>
const SESIONES_POST  = JSON.parse(document.getElementById("sesiones-post-data").textContent || "[]");
const HORARIOS_POST  = JSON.parse(document.getElementById("horarios-post-data").textContent || "[]");

// Horarios fijos (codes)
const HORARIOS = [
  { code: "9-1", label: "9:00 - 1:00" },
  { code: "2-6", label: "2:00 - 6:00" },
  { code: "9-6", label: "9:00 - 6:00" },
];

function totalClasesPorTipo() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  if (tipo.startsWith('full')) return 3;     // Full Day
  if (tipo === 'extendida') return 6;        // Extendida
  return 0;
}

function renderClases(n) {
  const $c = $('#sesiones_container');
  $c.empty();

  for (let i = 1; i <= n; i++) {
    const fechaVal = (SESIONES_POST[i-1] || "");
    const horarioVal = (HORARIOS_POST[i-1] || "");

    // botones radio (uno solo)
    const radiosHtml = HORARIOS.map(h => {
      const id = `hor_${i}_${h.code.replaceAll(':','').replaceAll('-','_')}`;
      const checked = (horarioVal === h.code) ? 'checked' : '';
      return `
        <input type="radio" class="btn-check" name="horario_${i}" id="${id}" value="${h.code}" autocomplete="off" ${checked} required>
        <label class="btn btn-outline-primary" for="${id}">${h.label}</label>
      `;
    }).join("");

    $c.append(`
      <div class="col-12 col-md-6">
        <div class="session-card">
          <div class="session-title">Sesi√≥n ${i}</div>

          <label class="form-label fw-semibold mb-1">Fecha</label>
          <input type="date" class="form-control mb-3" name="sesion_${i}" value="${fechaVal}" required>

          <label class="form-label fw-semibold mb-2">Horario</label>
          <div class="btn-group w-100" role="group" aria-label="Horario sesi√≥n ${i}">
            ${radiosHtml}
          </div>

          <div class="hint mt-2">El horario se guardar√° para mostrarlo en el modal de esta sesi√≥n.</div>
        </div>
      </div>
    `);
  }
}

function toggleUI() {
  const tipo = ($('#id_tipo_horario').val() || '').toLowerCase();
  const personalizar = $('#id_personalizar_fechas').is(':checked');

  const esFull = tipo.startsWith('full');
  const esExtendida = (tipo === 'extendida');
  const aplica = esFull || esExtendida;

  $('#dias_box').toggle(aplica && (!personalizar));
  $('#personalizado_box').toggleClass('hidden', !(aplica && personalizar));
  $('#fecha_inicio_box').toggle(!personalizar);

  if (aplica && personalizar) {
    const n = totalClasesPorTipo();
    $('#help_personalizado').text(
      esFull ? "Elige la fecha y el horario de cada sesi√≥n (Full Day = 3 sesiones)." :
      esExtendida ? "Elige la fecha y el horario de cada sesi√≥n (Extendida = 6 sesiones)." :
      ""
    );
    renderClases(n);
  }
}

$('#id_tipo_horario').on('change', toggleUI);
$('#id_personalizar_fechas').on('change', toggleUI);
$(document).ready(toggleUI);
</script>

</body>
</html>
