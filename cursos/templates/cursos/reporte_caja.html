<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Caja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4" style="max-width: 1200px;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">üìí Reporte de Caja</h3>
      <div class="text-muted">Filtra por fechas / m√©todo y exporta a Excel</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-success btn-sm fw-semibold"
         href="?fecha_ini={{ fecha_ini }}&fecha_fin={{ fecha_fin }}&metodo={{ metodo }}&export=1">
        ‚¨á Exportar Excel
      </a>
      <a href="{% url 'menu_admin' %}" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-semibold">Desde</label>
          <input type="date" name="fecha_ini" class="form-control" value="{{ fecha_ini }}">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Hasta</label>
          <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">M√©todo</label>
          <select name="metodo" class="form-select">
            <option value="">Todos</option>
            <option value="yape" {% if metodo == "yape" %}selected{% endif %}>Yape</option>
            <option value="plin" {% if metodo == "plin" %}selected{% endif %}>Plin</option>
            <option value="izipay" {% if metodo == "izipay" %}selected{% endif %}>Izipay</option>
            <option value="interbank" {% if metodo == "interbank" %}selected{% endif %}>Interbank</option>
            <option value="culqi" {% if metodo == "culqi" %}selected{% endif %}>Culqi</option>
            <option value="efectivo" {% if metodo == "efectivo" %}selected{% endif %}>Efectivo</option>
          </select>
        </div>

        <div class="col-md-3">
          <button class="btn btn-primary w-100 fw-semibold">Filtrar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div><strong>Total cobrado:</strong> S/ {{ total }}</div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold mb-2">Totales por m√©todo</div>
          {% if por_metodo %}
            <ul class="mb-0">
              {% for x in por_metodo %}
                <li>{{ x.metodo_pago|default:"‚Äî" }}: <strong>S/ {{ x.total }}</strong></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">Sin datos</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold mb-2">Totales por concepto</div>
          {% if por_concepto %}
            <ul class="mb-0">
              {% for x in por_concepto %}
                <li>{{ x.concepto|default:"‚Äî" }}: <strong>S/ {{ x.total }}</strong></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">Sin datos</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>Alumno</th>
              <th>Curso</th>
              <th>Concepto</th>
              <th>M√©todo</th>
              <th>Monto</th>
              <th>Asesora</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pagos %}
              <tr>
                <td>
                  {% if p.fecha_pago_real %}{{ p.fecha_pago_real|date:"d/m/Y" }}{% else %}‚Äî{% endif %}
                  <br><small class="text-muted">{{ p.creado_en|date:"d/m/Y H:i" }}</small>
                </td>

                <td>
                  {% if p.matricula and p.matricula.alumno %}
                    {{ p.matricula.alumno.nombre }} ({{ p.matricula.alumno.dni }})
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <td>
                  {% if p.matricula and p.matricula.curso %}
                    {{ p.matricula.curso.nombre }}
                  {% else %}
                    Servicio (sin curso)
                  {% endif %}
                </td>

                <td>{{ p.get_concepto_display }}</td>

                <td>
                  {% if p.metodo_pago %}{{ p.get_metodo_pago_display }}{% else %}‚Äî{% endif %}
                </td>

                <td class="fw-semibold">S/ {{ p.monto }}</td>

                <td>
                  {% if p.registrado_por %}
                    {{ p.registrado_por.get_full_name|default:p.registrado_por.username }}
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-muted py-4">Sin registros para el filtro.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
</body>
</html>
