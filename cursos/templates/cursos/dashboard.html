<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{ background:#f6f7fb; }
    .page-title{ font-weight:800; color:#0f172a; }
    .muted{ color:#64748b; }
    .card-soft{
      border:0; border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    .kpi{
      display:flex; gap:12px; align-items:center;
    }
    .kpi .icon{
      width:44px; height:44px; border-radius:12px;
      display:grid; place-items:center;
      background:#eef2ff; color:#1e40af; font-size:20px;
      flex:0 0 auto;
    }
    .kpi .value{ font-size:1.35rem; font-weight:800; color:#0f172a; line-height:1; }
    .kpi .label{ font-size:.85rem; color:#64748b; margin-top:4px; }
    .table thead th{ white-space:nowrap; }
  </style>
</head>

<body>
<div class="container py-4" style="max-width:1100px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <div class="page-title fs-3">Dashboard</div>
      <div class="muted">Resumen r√°pido de caja, matr√≠culas y asesores</div>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'menu_admin' %}" class="btn btn-outline-secondary">‚Üê Volver</a>
      <a href="{% url 'export_dashboard_excel' %}" class="btn btn-success">Exportar Excel</a>
    </div>
  </div>

  <!-- üîé Filtros -->
  <div class="card card-soft mb-3">
    <div class="card-body">
      <form id="filtros-form" class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label fw-semibold">Curso</label>
          <select id="curso" name="curso" class="form-select">
            <option value="">Todos los cursos</option>
            {% for curso in cursos %}
              <option value="{{ curso.id }}">{{ curso.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Periodo</label>
          <select id="periodo" name="periodo" class="form-select">
            <option value="semana">Semanal</option>
            <option value="mes" selected>Mensual</option>
            <option value="anio">Anual</option>
          </select>
          <div class="form-text">Afecta alumnos por curso, deuda y cobros.</div>
        </div>

        <div class="col-md-3">
          <button class="btn btn-primary w-100">Aplicar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ‚úÖ KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card card-soft">
        <div class="card-body kpi">
          <div class="icon">üí∞</div>
          <div>
            <div class="value" id="kpi_total_cobrado">S/ {{ total_cobrado|default:"0.00" }}</div>
            <div class="label">Total cobrado (periodo)</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card card-soft">
        <div class="card-body kpi">
          <div class="icon">üßæ</div>
          <div>
            <div class="value" id="kpi_ops">{{ operaciones|default:"0" }}</div>
            <div class="label">Operaciones (periodo)</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card card-soft">
        <div class="card-body kpi">
          <div class="icon">üéØ</div>
          <div>
            <div class="value" id="kpi_ticket">S/ {{ ticket_promedio|default:"0.00" }}</div>
            <div class="label">Ticket promedio</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card card-soft">
        <div class="card-body kpi">
          <div class="icon">‚ö†Ô∏è</div>
          <div>
            <div class="value" id="kpi_deuda">S/ {{ deuda_total|default:"0.00" }}</div>
            <div class="label">
              Deuda total ¬∑ <span id="kpi_deudores">{{ alumnos_con_deuda|default:"0" }}</span> alumnos con saldo
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Top asesores -->
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card card-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">üèÜ Top asesores (monto del mes)</div>
            <span class="badge bg-primary">Top 5</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle text-center mb-0">
              <thead class="table-dark">
                <tr><th>#</th><th>Asesor(a)</th><th>Total</th><th>Ops</th></tr>
              </thead>
              <tbody>
                {% for a in top_monto %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>
                    {% if a.registrado_por__first_name %}
                      {{ a.registrado_por__first_name }} {{ a.registrado_por__last_name }}
                    {% else %}
                      {{ a.registrado_por__username }}
                    {% endif %}
                  </td>
                  <td class="fw-semibold">S/ {{ a.total }}</td>
                  <td>{{ a.cantidad }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-muted py-3">Sin ventas este mes.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="form-text mt-2">Monto del mes = qui√©n cobra m√°s dinero.</div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card card-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">üìà Top asesores (cantidad del mes)</div>
            <span class="badge bg-primary">Top 5</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle text-center mb-0">
              <thead class="table-dark">
                <tr><th>#</th><th>Asesor(a)</th><th>Ops</th><th>Total</th></tr>
              </thead>
              <tbody>
                {% for a in top_cantidad %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ a.registrado_por__username }}</td>
                  <td class="fw-semibold">{{ a.cantidad }}</td>
                  <td>S/ {{ a.total }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-muted py-3">Sin registros este mes.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="form-text mt-2">Cantidad del mes = qui√©n hace m√°s cobros.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Gr√°ficos -->
  <div class="row g-3">
    <div class="col-md-7">
      <div class="card card-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">Alumnos por curso (seg√∫n periodo)</div>
            <div class="muted small">Semanal / Mensual / Anual</div>
          </div>
          <canvas id="alumnosChart" height="120"></canvas>
          <div id="alumnosEmpty" class="text-muted small mt-2 d-none">No hay matr√≠culas en este periodo.</div>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card card-soft">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">Cobros por m√©todo (periodo)</div>
            <div class="muted small">Ideal para cuadrar caja</div>
          </div>
          <canvas id="metodosChart" height="160"></canvas>
          <div id="metodosEmpty" class="text-muted small mt-2 d-none">No hay cobros en este periodo.</div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  let alumnosChart = null;
  let metodosChart = null;

  function setEmpty(elId, show){
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.toggle("d-none", !show);
  }

  function buildAlumnosChart(labels, values){
    const ctx = document.getElementById('alumnosChart').getContext('2d');
    if (alumnosChart) alumnosChart.destroy();

    const hasData = values && values.some(v => Number(v) > 0);
    setEmpty("alumnosEmpty", !hasData);

    alumnosChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Matr√≠culas', data: values }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

function buildMetodosChart(labels, values){
  const canvas = document.getElementById('metodosChart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');

  if (metodosChart) metodosChart.destroy();

  const hasData = values && values.some(v => Number(v) > 0);
  setEmpty("metodosEmpty", !hasData);

  // ‚úÖ si no hay data, no dibujes
  if (!hasData) {
    metodosChart = null;
    return;
  }

  metodosChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values }] },
    options: {
      responsive: true,
      plugins: { legend: { position: "bottom" } }
    }
  });
}


  // ‚úÖ AJAX filtros
  document.getElementById('filtros-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const curso = document.getElementById('curso').value;
    const periodo = document.getElementById('periodo').value;

    const params = new URLSearchParams({ curso, periodo });

    fetch(`/cursos/datos-dashboard/?${params.toString()}`)
      .then(r => r.json())
      .then(data => {
        buildAlumnosChart(
          (data.alumnos_por_curso || []).map(x => x.nombre),
          (data.alumnos_por_curso || []).map(x => x.total_alumnos)
        );

        // KPIs
        document.getElementById('kpi_total_cobrado').innerText = "S/ " + (data.total_cobrado || "0.00");
        document.getElementById('kpi_ops').innerText = data.operaciones ?? 0;
        document.getElementById('kpi_ticket').innerText = "S/ " + (data.ticket_promedio || "0.00");
        document.getElementById('kpi_deuda').innerText = "S/ " + (data.deuda_total || "0.00");
        document.getElementById('kpi_deudores').innerText = data.alumnos_con_deuda ?? 0;

        // M√©todos (nuevo indicador)
        const pm = data.por_metodo || [];
        buildMetodosChart(
          pm.map(x => x.metodo),
          pm.map(x => x.total)
        );
      })
      .catch(err => console.error("Error dashboard:", err));
  });
</script>

</body>
</html>
